version: '3.8'

services:
  # 前端服务
  frontend:
    # build: ./frontend
    image: swr.cn-north-4.myhuaweicloud.com/ni_haochen/blog-frontend:v1.1
    ports:
      - "80:80"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
    restart: always
    networks:
      - blog_net

  # 后端服务
  backend:
    # build: ./backend
    # 你的镜像地址保持不变
    image: swr.cn-north-4.myhuaweicloud.com/ni_haochen/blog-backend:v1.1
    restart: always
    # 【关键修改1】给予容器最高权限，绕过部分安全限制
    privileged: true
    # 【关键修改2】解除容器内的进程/线程数量限制 (PIDs)
    pids_limit: -1
    # 【关键修改3】强制修改 Linux 内核限制 (nproc)
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    environment:
      - DATABASE_URL=${DATABASE_URL}
      # 【关键修改4】从代码层面限制 Python 不要疯狂开线程
      # 限制 AnyIO (FastAPI 依赖库) 的最大线程数，默认为 40，这里限制为 10
      - ANYIO_WORKER_THREADS=10
      # 限制数据库连接池
      - SQLALCHEMY_POOL_SIZE=5
      - SQLALCHEMY_MAX_OVERFLOW=5
    volumes:
      - ./backend/uploads:/app/uploads
    depends_on:
      - db
    networks:
      - blog_net

  # 数据库服务
  db:
    # 降级到 5.7，只有 8.0 一半的内存占用
    image: mysql:5.7
    container_name: blog_db
    restart: always
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - blog_net

volumes:
  db_data:

networks:
  blog_net:
    driver: bridge
